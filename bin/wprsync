#!/usr/bin/env python

# This is a convenience script that specifically syncs the docker dir in this repo with the remote host generated by terraform using rysnc. In the future should watch for file changes and sync + be able to specify user and dirs

import subprocess
import re
from pathlib import Path

def run_command(command):
    p = subprocess.Popen(
        command,
        stdout=subprocess.PIPE,
        stderr=subprocess.STDOUT
    )
    return iter(p.stdout.readline, b'')

ansible_hosts = Path(__file__).resolve().parent.parent / 'ansible' / 'hosts'
docker_dir = Path(__file__).resolve().parent.parent / "docker"
contents = ansible_hosts.read_text()
host_ips = re.findall(r'\d+.\d+.\d+.\d+', contents)

if len(host_ips) > 1:
    print("Multiple Host ips found exiting")
else:
    command = f'rsync -azP --delete --exclude *.swp {docker_dir}/ ubuntu@{host_ips[0]}:/home/ubuntu/docker'.split()
    for line in run_command(command):
        if line:
            print(line.decode('utf-8').strip('\n'))
